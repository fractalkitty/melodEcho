<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta charset="UTF-8" />
    <title>melodecho</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.0/lib/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.0/lib/addons/p5.sound.min.js"></script>

    <style>
      /* Base styles */
      body {
        background-color: #1a1a1a;
        color: #e0e0e0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: min(20px, 4vw);
        max-width: 100%;
        margin: 0 auto;
        box-sizing: border-box;
      }

      .game-button:disabled {
        background: #404040;
        color: #666;
        cursor: not-allowed;
      }

      .note-row {
        display: flex;
        gap: 4px;
        margin: 10px 0;
      }

      .note-button {
        width: min(40px, 8vw);
        height: min(40px, 8vw);
        border: 2px solid #444;
        background: #2d2d2d;
        color: #e0e0e0;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .note-button:hover {
        background: #3d3d3d;
        border-color: #555;
      }

      .note-button.selected {
        background: #c1fbfa; /* Much lighter grey for selected state */
        color: white;
        border-color: #999; /* Lighter border for selected state */
      }

      .note-button.correct {
        background: #40ce47;
        color: white;
        border-color: #1b5e20;
        cursor: not-allowed;
      }

      .note-button.playing {
        background: #1976d2;
        color: white;
        border-color: #1565c0;
      }

      h1 {
        font-size: clamp(1.5rem, 5vw, 2.5rem);
        text-align: center;
        color: #fff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      #attempts,
      #plays-remaining {
        font-size: clamp(0.8rem, 4vw, 1.2rem);
        text-align: center;
        color: #bbb;
      }

      .game-controls {
        margin: 20px;
        display: flex;
        gap: 10px;
        flex-direction: column;
        align-items: center;
      }

      .game-button {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        background: #1976d2;
        color: white;
        cursor: pointer;
        width: min(200px, 80vw);
        font-size: clamp(14px, 3vw, 16px);
        transition: background-color 0.2s;
      }

      .game-button:hover:not(:disabled) {
        background: #1565c0;
      }

      #plays-remaining {
        font-size: 0.9em;
        color: #888;
        margin: 5px 0;
      }

      .keyboard-row {
        margin-bottom: 20px;
        padding: 10px;
        background: #2d2d2d;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .test-button {
        background: #333;
        border: 2px solid #444;
        color: #e0e0e0;
      }

      .test-button:hover {
        background: #404040;
      }

      .test-button.playing {
        background: #1976d2;
        color: white;
        border-color: #1565c0;
      }

      /* Media query for small devices */
      @media (max-width: 600px) {
        .note-row {
          gap: 1px;
        }

        .note-button {
          width: 28px;
          height: 28px;
          font-size: 12px;
        }

        .keyboard-row {
          padding: 5px;
        }

        .game-controls {
          margin: 10px;
          gap: 8px;
        }
      }

      /* Media query for very small devices */
      @media (max-width: 350px) {
        .note-button {
          width: 24px;
          height: 24px;
        }
      }

      /* Prevent zooming on mobile when clicking buttons */
      @media (max-width: 768px) {
        button {
          touch-action: manipulation;
        }
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #2d2d2d;
        color: #e0e0e0;
        padding: 20px;
        border-radius: 8px;
        max-width: 90%;
        width: 300px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      .modal.show {
        display: flex;
      }

      .share-text {
        margin: 20px 0;
        padding: 10px;
        background: #333;
        border-radius: 4px;
        white-space: pre-wrap;
        font-family: monospace;
        color: #e0e0e0;
      }

      .close-modal {
        float: right;
        cursor: pointer;
        font-size: 1.5em;
        line-height: 1;
        color: #e0e0e0;
      }

      /* Message styling */
      #message {
        color: #4caf50;
        font-weight: bold;
        margin-top: 20px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <h1>Melodecho</h1>
      <div id="attempts">Attempts remaining: 5</div>
      <div id="test-keyboard"></div>
      <div class="note-spacer" style="height: 20px"></div>
      <div id="note-grid"></div>
      <div class="game-controls">
        <button id="playTarget" class="game-button">Play Target Melody</button>
        <div id="plays-remaining">2 plays remaining</div>
        <button id="submit" class="game-button">Submit Guess</button>
        <button id="newGame" class="game-button">New Game</button>
      </div>
      <div id="message"></div>
    </div>

    <div id="shareModal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Share your result!</h2>
        <div id="modalShareText" class="share-text"></div>
        <button id="copyButton" class="game-button">Copy to Clipboard</button>
      </div>
    </div>

    <script>
      let notes = [];
      let targetMelody = [];
      let currentGuess = new Array(6).fill(0);
      let attempts = 5;
      let playsRemaining = 2;
      let correctButtons = new Set();
      let isPlaying = false;
      let pTime = 1000; // Ensure each sound is played for 800ms
      let guessHistory = [];
      let gameWon = false;

      function preload() {
        for (let i = 0; i < 12; i++) {
          notes[i] = loadSound(
            `https://assets.codepen.io/4559259/${i + 30}.mp3`,
            () => {
              // console.log(`Note ${i} loaded successfully`);
            },
            () => {
              console.error(`Failed to load note ${i}`);
            }
          );
        }
      }

      function setup() {
        noCanvas();

        // Create the test keyboard
        const keyboardDiv = document.getElementById("test-keyboard");
        const keyboardRow = document.createElement("div");
        keyboardRow.className = "note-row keyboard-row";

        for (let col = 0; col < 12; col++) {
          const button = document.createElement("button");
          button.className = "note-button test-button";

          button.addEventListener("click", () => {
            const note = notes[col];
            if (note.isLoaded()) {
              stopAllSounds();
              note.play();
              button.classList.add("playing");

              setTimeout(() => {
                button.classList.remove("playing");
                note.stop();
              }, pTime);
            } else {
              console.error(`Note ${col} is not loaded`);
            }
          });

          button.addEventListener("touchstart", (e) => {
            e.preventDefault(); // Prevent double-firing on mobile
            const note = notes[col];
            if (note.isLoaded()) {
              stopAllSounds();
              note.play();
              button.classList.add("playing");

              setTimeout(() => {
                button.classList.remove("playing");
                note.stop();
              }, pTime);
            } else {
              console.error(`Note ${col} is not loaded`);
            }
          });

          keyboardRow.appendChild(button);
        }
        keyboardDiv.appendChild(keyboardRow);

        // Generate first note randomly
        targetMelody = [floor(random(12))];

        // Generate remaining 5 notes within Â±4 steps of previous note
        for (let i = 1; i < 6; i++) {
          let prevNote = targetMelody[i - 1];
          let minNote = Math.max(0, prevNote - 4);
          let maxNote = Math.min(11, prevNote + 4);
          targetMelody.push(floor(random(minNote, maxNote + 1)));
        }

        // Create main game grid
        const gridDiv = document.getElementById("note-grid");
        for (let row = 0; row < 6; row++) {
          const rowDiv = document.createElement("div");
          rowDiv.className = "note-row";

          for (let col = 0; col < 12; col++) {
            const button = document.createElement("button");
            button.className = "note-button";
            button.id = `button-${row}-${col}`;

            button.addEventListener("click", () => {
              if (!correctButtons.has(row) && !isPlaying) {
                // Deselect all buttons in this row
                for (let i = 0; i < 12; i++) {
                  document
                    .getElementById(`button-${row}-${i}`)
                    .classList.remove("selected");
                }
                // Select this button
                button.classList.add("selected");
                currentGuess[row] = col;
              }
            });

            rowDiv.appendChild(button);
          }
          gridDiv.appendChild(rowDiv);
        }

        document.getElementById("playTarget").addEventListener("click", () => {
          if (!isPlaying && playsRemaining > 0) {
            playMelody(targetMelody, false);
            playsRemaining--;
            updatePlaysRemaining();
          }
        });

        document.getElementById("submit").addEventListener("click", () => {
          if (!isPlaying) {
            checkGuess();
          }
        });

        document.getElementById("newGame").addEventListener("click", resetGame);

        document.querySelector(".close-modal").addEventListener("click", () => {
          closeModal();
        });

        document.getElementById("copyButton").addEventListener("click", () => {
          const shareText =
            document.getElementById("modalShareText").textContent;
          navigator.clipboard.writeText(shareText).then(() => {
            alert("Results copied to clipboard!");
            closeModal();
          });
        });
        document.addEventListener(
          "touchstart",
          function () {
            if (getAudioContext().state !== "running") {
              getAudioContext().resume();
            }
          },
          { once: true }
        );
      }

      function stopAllSounds() {
        // Resume context before stopping sounds
        if (getAudioContext().state === "suspended") {
          getAudioContext().resume();
        }

        notes.forEach((note) => {
          if (note && note.isLoaded() && note.isPlaying()) {
            note.stop();
          }
        });
        isPlaying = false;
      }

      function updatePlaysRemaining() {
        document.getElementById(
          "plays-remaining"
        ).textContent = `${playsRemaining} plays remaining`;
        document.getElementById("playTarget").disabled = playsRemaining === 0;
      }

      function playNote(index, rowIndex = -1, highlightRow = true) {
        // Resume audio context
        if (getAudioContext().state === "suspended") {
          getAudioContext().resume();
        }

        const note = notes[index];
        if (note.isLoaded()) {
          // Create a promise to handle note playing
          return new Promise((resolve) => {
            try {
              note.play();
            } catch (e) {
              console.error("Error playing note:", e);
              // Try to recover by resuming context and playing again
              getAudioContext()
                .resume()
                .then(() => {
                  note.play();
                });
            }

            if (rowIndex >= 0 && highlightRow) {
              const button = document.getElementById(
                `button-${rowIndex}-${index}`
              );
              button.classList.add("playing");
              setTimeout(() => {
                button.classList.remove("playing");
              }, pTime);
            }

            // Wait for note to finish before resolving
            setTimeout(() => {
              note.stop();
              resolve();
            }, pTime);
          });
        } else {
          console.error(`Note ${index} is not loaded`);
          return Promise.resolve();
        }
      }

      function playMelody(melody, highlightNotes = true) {
        stopAllSounds();
        isPlaying = true;
        document.getElementById("submit").disabled = true;
        document.getElementById("playTarget").disabled = true;

        let lastHighlightedRow = -1;

        // Play notes sequentially using async/await
        async function playSequence() {
          for (let i = 0; i < melody.length; i++) {
            const noteIndex = melody[i];
            // console.log(`Playing note ${noteIndex} at position ${i}`);

            if (!highlightNotes) {
              if (lastHighlightedRow >= 0) {
                for (let col = 0; col < 12; col++) {
                  const prevButton = document.getElementById(
                    `button-${lastHighlightedRow}-${col}`
                  );
                  prevButton.style.border = "2px solid #ccc";
                }
              }
              for (let col = 0; col < 12; col++) {
                const button = document.getElementById(`button-${i}-${col}`);
                button.style.border = "2px solid #2196F3";
              }
              lastHighlightedRow = i;
              await playNote(noteIndex);
            } else {
              await playNote(noteIndex, i, true);
            }

            // Add small buffer between notes
            await new Promise((resolve) => setTimeout(resolve, 100));
          }

          // Reset UI after sequence completes
          setTimeout(() => {
            isPlaying = false;
            document.getElementById("submit").disabled = false;
            if (playsRemaining > 0) {
              document.getElementById("playTarget").disabled = false;
            }
            if (!highlightNotes && lastHighlightedRow >= 0) {
              for (let col = 0; col < 12; col++) {
                const button = document.getElementById(
                  `button-${lastHighlightedRow}-${col}`
                );
                button.style.border = "2px solid #ccc";
              }
            }
          }, 500);
        }

        playSequence();
      }

      function checkGuess() {
        if (attempts <= 0 || gameWon) return;

        playMelody(currentGuess, true);

        let allCorrect = true;
        currentGuess.forEach((note, index) => {
          if (note === targetMelody[index]) {
            correctButtons.add(index);
            for (let i = 0; i < 12; i++) {
              const button = document.getElementById(`button-${index}-${i}`);
              button.classList.remove("selected", "playing");
              if (i === note) {
                button.classList.add("correct");
              }
            }
          } else {
            allCorrect = false;
          }
        });

        // Track the guess history
        guessHistory.push([...currentGuess]);

        attempts--;
        playsRemaining = 2;
        document.getElementById(
          "attempts"
        ).textContent = `Attempts remaining: ${attempts}`;
        updatePlaysRemaining();

        if (allCorrect) {
          gameWon = true;
          document.getElementById("message").textContent = "You won! ððð";
          document.getElementById("submit").disabled = true;
          document.getElementById("playTarget").disabled = true;
          showShareModal();
        } else if (attempts <= 0) {
          document.getElementById("message").textContent = "Game Over!";
          document.getElementById("submit").disabled = true;
          document.getElementById("playTarget").disabled = true;
        }
      }

      function resetGame() {
        // Resume audio context first
        getAudioContext()
          .resume()
          .then(() => {
            gameWon = false;
            guessHistory = [];
            stopAllSounds();

            // Reset game state
            attempts = 5;
            playsRemaining = 2;
            correctButtons.clear();
            isPlaying = false;
            currentGuess = new Array(6).fill(0);

            // Generate new melody
            targetMelody = [floor(random(12))];
            for (let i = 1; i < 6; i++) {
              let prevNote = targetMelody[i - 1];
              let minNote = Math.max(0, prevNote - 4);
              let maxNote = Math.min(11, prevNote + 4);
              targetMelody.push(floor(random(minNote, maxNote + 1)));
            }

            // Reset UI
            document.getElementById("attempts").textContent =
              "Attempts remaining: 5";
            document.getElementById("message").textContent = "";
            document.getElementById("plays-remaining").textContent =
              "2 plays remaining";
            document.getElementById("submit").disabled = false;
            document.getElementById("playTarget").disabled = false;

            // Reset all buttons
            for (let row = 0; row < 6; row++) {
              for (let col = 0; col < 12; col++) {
                const button = document.getElementById(`button-${row}-${col}`);
                button.className = "note-button";
                button.style.border = "2px solid #444";
              }
            }

            // Log audio context state for debugging
            console.log(
              "Audio context state after reset:",
              getAudioContext().state
            );
          });
      }

      function showShareModal() {
        if (!gameWon) return;
        const shareText = generateShareText();
        document.getElementById("modalShareText").textContent = shareText;
        document.getElementById("shareModal").classList.add("show");
        document.getElementById("submit").disabled = true;
      }

      function closeModal() {
        document.getElementById("shareModal").classList.remove("show");
      }
      function melodyToNumber(melody) {
        // Convert melody array to base-12 number
        return melody.reduce((acc, note, i) => {
          return acc + note * Math.pow(12, 5 - i);
        }, 0);
      }

      function padNumber(num) {
        // 12^6 = 2,985,984 so we need 7 digits
        return num.toString().padStart(7, "0");
      }
      function generateShareText() {
        const melodyNum = melodyToNumber(targetMelody);
        let shareText = `MelodEcho #${padNumber(melodyNum)}\n\n`;

        // For each attempt made (up to 5)
        guessHistory.forEach((guess, rowIndex) => {
          let rowText = "";
          // For each note position (6 notes)
          guess.forEach((note, colIndex) => {
            if (note === targetMelody[colIndex]) {
              rowText += "ð©";
            } else {
              rowText += "â¬";
            }
          });
          shareText += rowText + "\n";
        });

        // Get actual attempts made
        const attemptsUsed = 5 - attempts;

        shareText += `\nSolved in ${attemptsUsed} attempts!\n`;
        shareText += `The melody was: ${targetMelody.join(",")}\n`;
        shareText += "fractalkitty.com/melodecho";

        return shareText;
      }
    </script>
  </body>
</html>
